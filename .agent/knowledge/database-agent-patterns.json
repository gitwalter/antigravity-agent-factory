{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "id": "database-agent-patterns",
  "name": "Database Agent Patterns",
  "title": "Database Agent Patterns",
  "description": "Patterns for building AI agents that interact with databases through natural language, generating and optimizing SQL queries",
  "version": "1.0.0",
  "category": "integration",
  "axiomAlignment": {
    "A1_verifiability": "Query logging and confidence scores enable verification of agent outputs",
    "A2_user_primacy": "Read-only restriction and user questions drive agent behavior",
    "A3_transparency": "Schema context and SQL explanation make generation traceable",
    "A4_non_harm": "Validation, parameterization, and LIMIT prevent harmful queries",
    "A5_consistency": "Unified patterns for text-to-SQL, validation, and error handling"
  },
  "related_skills": [
    "database-agents",
    "langchain-usage",
    "tool-usage",
    "mcp-integration"
  ],
  "related_knowledge": [
    "langchain-patterns.json",
    "api-design-patterns.json",
    "ai-security-patterns.json"
  ],
  "patterns": {
    "text_to_sql_basic_generation_description": {
      "description": "Generate SQL queries from natural language questions",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# text_to_sql_basic_generation_description pattern for database-agent-patterns\n# Implement based on description: Generate SQL queries from natural language questio...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "text_to_sql_basic_generation_example": {
      "description": "Question: 'How many users are in the database?' -> SQL: 'SELECT COUNT(*) FROM users'",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# text_to_sql_basic_generation_example pattern for database-agent-patterns\n# Implement based on description: Question: 'How many users are in the database?' ->...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "text_to_sql_basic_generation_components": {
      "description": "['Schema introspection', 'LLM prompt engineering', 'SQL extraction from LLM response']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "text_to_sql_basic_generation_best_practices": {
      "description": "['Include full database schema in prompt', 'Use structured output parsers', 'Extract SQL from markdown code blocks', 'Validate SQL syntax before execution']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "text_to_sql_schema_aware_description": {
      "description": "Generate SQL with awareness of schema relationships",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# text_to_sql_schema_aware_description pattern for database-agent-patterns\n# Implement based on description: Generate SQL with awareness of schema relationship...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "text_to_sql_schema_aware_components": {
      "description": "['Foreign key relationships', 'Table aliases', 'JOIN optimization', 'Index awareness']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "text_to_sql_schema_aware_example": {
      "description": "Question: 'Show orders with customer names' -> SQL with proper JOINs based on foreign keys",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# text_to_sql_schema_aware_example pattern for database-agent-patterns\n# Implement based on description: Question: 'Show orders with customer names' -> SQL...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "text_to_sql_structured_output_description": {
      "description": "Use Pydantic models for structured SQL generation",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# text_to_sql_structured_output_description pattern for database-agent-patterns\n# Implement based on description: Use Pydantic models for structured SQL generation...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "text_to_sql_structured_output_example": {
      "description": "class SQLQuery(BaseModel):\n    query: str\n    explanation: str\n    confidence: float",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# text_to_sql_structured_output_example pattern for database-agent-patterns\n# Implement based on description: class SQLQuery(BaseModel):\n    query: str\n    expl...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "text_to_sql_structured_output_benefits": {
      "description": "['Type safety', 'Confidence scoring', 'Better error handling']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "schema_introspection_extraction_description": {
      "description": "Extract database schema information using SQLAlchemy inspector",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# schema_introspection_extraction_description pattern for database-agent-patterns\n# Implement based on description: Extract database schema information using SQLAlche...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "schema_introspection_extraction_components": {
      "description": "['Table names', 'Column definitions (name, type, nullable)', 'Foreign key relationships', 'Indexes']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "schema_introspection_extraction_example": {
      "description": "inspector = inspect(engine)\nfor table_name in inspector.get_table_names():\n    columns = inspector.get_columns(table_name)",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# schema_introspection_extraction_example pattern for database-agent-patterns\n# Implement based on description: inspector = inspect(engine)\nfor table_name in insp...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "schema_introspection_formatting_description": {
      "description": "Format schema as text for LLM prompts",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# schema_introspection_formatting_description pattern for database-agent-patterns\n# Implement based on description: Format schema as text for LLM prompts...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "schema_introspection_formatting_format": {
      "description": "Table: {name}\nColumns:\n  - {col_name} ({type}) {nullable}\nForeign Keys:\n  - {cols} -> {ref_table}.{ref_cols}",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# schema_introspection_formatting_format pattern for database-agent-patterns\n# Implement based on description: Table: {name}\nColumns:\n  - {col_name} ({type}) {nu...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "schema_introspection_formatting_best_practices": {
      "description": "['Include column types', 'Show nullable constraints', 'List foreign key relationships', 'Include index information']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "schema_introspection_sample_data_description": {
      "description": "Include sample data rows to help LLM understand data",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# schema_introspection_sample_data_description pattern for database-agent-patterns\n# Implement based on description: Include sample data rows to help LLM understand da...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "schema_introspection_sample_data_use_when": {
      "description": "['Complex data types', 'Unclear column meanings', 'Need for better context']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "query_optimization_execution_plan_analysis_description": {
      "description": "Analyze query execution plans for optimization",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# query_optimization_execution_plan_analysis_description pattern for database-agent-patterns\n# Implement based on description: Analyze query execution plans for optimization...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "query_optimization_execution_plan_analysis_approach": {
      "description": "['Use EXPLAIN ANALYZE', 'Identify full table scans', 'Find missing indexes', 'Detect inefficient JOINs']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "query_optimization_optimization_prompt_description": {
      "description": "Use LLM to optimize SQL queries",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# query_optimization_optimization_prompt_description pattern for database-agent-patterns\n# Implement based on description: Use LLM to optimize SQL queries...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "query_optimization_optimization_prompt_goals": {
      "description": "['Reduce execution time', 'Minimize data scanned', 'Use indexes effectively', 'Avoid unnecessary JOINs', 'Optimize WHERE clause order']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "query_optimization_optimization_prompt_example": {
      "description": "Prompt LLM with original query, schema, and execution plan to generate optimized version",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# query_optimization_optimization_prompt_example pattern for database-agent-patterns\n# Implement based on description: Prompt LLM with original query, schema, and execut...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "query_optimization_index_awareness_description": {
      "description": "Consider indexes when generating queries",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# query_optimization_index_awareness_description pattern for database-agent-patterns\n# Implement based on description: Consider indexes when generating queries...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "query_optimization_index_awareness_best_practices": {
      "description": "['Filter on indexed columns first', 'Use covering indexes when possible', 'Avoid functions on indexed columns in WHERE clauses']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "error_handling_sql_validation_description": {
      "description": "Validate SQL before execution",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# error_handling_sql_validation_description pattern for database-agent-patterns\n# Implement based on description: Validate SQL before execution...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "error_handling_sql_validation_checks": {
      "description": "['Only SELECT queries allowed', 'Syntax validation', 'Schema validation (table/column existence)', 'LIMIT clause enforcement']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "error_handling_sql_validation_example": {
      "description": "query_upper = query.strip().upper()\nif not query_upper.startswith('SELECT'):\n    raise ValueError('Only SELECT queries allowed')",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# error_handling_sql_validation_example pattern for database-agent-patterns\n# Implement based on description: query_upper = query.strip().upper()\nif not query_u...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "error_handling_execution_errors_description": {
      "description": "Handle SQL execution errors gracefully",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# error_handling_execution_errors_description pattern for database-agent-patterns\n# Implement based on description: Handle SQL execution errors gracefully...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "error_handling_execution_errors_patterns": {
      "description": "['Catch database exceptions', 'Return structured error responses', 'Include original query in error response', 'Provide helpful error messages']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "error_handling_execution_errors_example": {
      "description": "try:\n    result = conn.execute(text(query))\n    return {'error': None, 'rows': result.fetchall()}\nexcept Exception as e:\n    return {'error': str(e), 'rows': None}",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# error_handling_execution_errors_example pattern for database-agent-patterns\n# Implement based on description: try:\n    result = conn.execute(text(query))\n    re...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "error_handling_result_limiting_description": {
      "description": "Enforce result set limits",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# error_handling_result_limiting_description pattern for database-agent-patterns\n# Implement based on description: Enforce result set limits...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "error_handling_result_limiting_approach": {
      "description": "['Add LIMIT if not present', 'Set maximum LIMIT value', 'Warn on large result sets', 'Implement pagination for large queries']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "security_query_restriction_description": {
      "description": "Restrict to read-only operations",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# security_query_restriction_description pattern for database-agent-patterns\n# Implement based on description: Restrict to read-only operations...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "security_query_restriction_rules": {
      "description": "['Only allow SELECT queries', 'Block DML (INSERT, UPDATE, DELETE)', 'Block DDL (CREATE, DROP, ALTER)', 'Block stored procedure calls']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "security_sql_injection_prevention_description": {
      "description": "Prevent SQL injection attacks",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# security_sql_injection_prevention_description pattern for database-agent-patterns\n# Implement based on description: Prevent SQL injection attacks...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "security_sql_injection_prevention_methods": {
      "description": "['Use parameterized queries when possible', 'Validate table/column names against schema', 'Sanitize user inputs', 'Avoid string concatenation for SQL']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "security_access_control_description": {
      "description": "Control database access",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# security_access_control_description pattern for database-agent-patterns\n# Implement based on description: Control database access...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "security_access_control_patterns": {
      "description": "['Use read-only database users', 'Limit to specific schemas/databases', 'Implement row-level security', 'Audit all queries']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "pipeline_complete_flow_description": {
      "description": "End-to-end text-to-SQL pipeline",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# pipeline_complete_flow_description pattern for database-agent-patterns\n# Implement based on description: End-to-end text-to-SQL pipeline...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "pipeline_complete_flow_steps": {
      "description": "['1. Schema introspection', '2. Natural language question', '3. SQL generation with LLM', '4. SQL validation', '5. Query execution', '6. Result formatting', '7. Natural language summary']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "pipeline_complete_flow_example": {
      "description": "DatabaseAgent.query(question) -> SQL -> Results -> Summary",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# pipeline_complete_flow_example pattern for database-agent-patterns\n# Implement based on description: DatabaseAgent.query(question) -> SQL -> Results ->...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "pipeline_result_summarization_description": {
      "description": "Generate natural language summaries of query results",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# pipeline_result_summarization_description pattern for database-agent-patterns\n# Implement based on description: Generate natural language summaries of query resul...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    },
    "pipeline_result_summarization_use_when": {
      "description": "['Large result sets', 'Aggregate queries', 'Complex analytical queries']",
      "use_when": "See description for when to apply this pattern.",
      "code_example": "See description for when to apply this pattern.",
      "best_practices": [
        "Review and validate implementation against domain requirements",
        "Review and validate implementation against domain requirements"
      ]
    },
    "pipeline_result_summarization_approach": {
      "description": "Use LLM to summarize results in context of original question",
      "use_when": "Apply when implementing this pattern in your domain context",
      "code_example": "# pipeline_result_summarization_approach pattern for database-agent-patterns\n# Implement based on description: Use LLM to summarize results in context of origina...",
      "best_practices": [
        "Validate implementation against domain requirements",
        "Document the pattern usage and rationale in code"
      ]
    }
  },
  "best_practices": [
    "Always validate and sanitize generated SQL before execution",
    "Restrict to SELECT queries only to prevent data modification",
    "Use schema introspection for accurate queries that match actual database structure",
    "Add LIMIT clauses to prevent large result sets and memory issues",
    "Implement query result caching for frequently asked questions",
    "Log all generated queries for auditing and debugging purposes",
    "Provide confidence scores for generated queries to indicate reliability",
    "Handle SQL errors gracefully with structured error responses",
    "Use parameterized queries when possible to prevent SQL injection",
    "Consider query optimization suggestions based on execution plans",
    "Include foreign key relationships in schema context for better JOIN generation",
    "Format schema clearly for LLM consumption with table and column descriptions",
    "Use structured output parsers for reliable SQL extraction from LLM responses",
    "Implement retry logic for transient failures with exponential backoff",
    "Monitor query performance and optimize slow queries automatically"
  ],
  "anti_patterns": [
    {
      "name": "No SQL validation",
      "problem": "Malformed or dangerous queries can execute, causing errors or security issues",
      "fix": "Validate syntax and restrict to SELECT only, use SQL parsers for validation"
    },
    {
      "name": "Allowing DML/DDL",
      "problem": "Agents can modify or delete data, violating read-only principle",
      "fix": "Restrict to SELECT queries only, validate query type before execution"
    },
    {
      "name": "No LIMIT clauses",
      "problem": "Large result sets can cause memory issues and slow down the system",
      "fix": "Always add LIMIT for safety, set maximum result set size, implement pagination"
    },
    {
      "name": "Ignoring schema",
      "problem": "Generated queries reference non-existent tables/columns, causing execution failures",
      "fix": "Use schema introspection and include full schema context in prompts"
    },
    {
      "name": "No error handling",
      "problem": "SQL errors break agent loop, preventing graceful recovery",
      "fix": "Wrap execution in try/except and return structured errors with helpful messages"
    },
    {
      "name": "Hardcoded queries",
      "problem": "Not flexible, doesn't adapt to schema changes, requires code updates",
      "fix": "Generate dynamically from schema, use LLM for query generation"
    },
    {
      "name": "No query logging",
      "problem": "Cannot debug or audit agent behavior, difficult to improve",
      "fix": "Log all generated queries with metadata including user, timestamp, and results"
    },
    {
      "name": "Ignoring indexes",
      "problem": "Inefficient queries, slow performance, high database load",
      "fix": "Consider indexes in optimization and generation, analyze execution plans"
    },
    {
      "name": "String concatenation for SQL",
      "problem": "SQL injection vulnerability, security risk",
      "fix": "Use parameterized queries or validate inputs against schema"
    },
    {
      "name": "No confidence scoring",
      "problem": "Cannot assess query reliability, users may trust incorrect results",
      "fix": "Include confidence scores in structured output, allow low-confidence queries to be reviewed"
    }
  ]
}
