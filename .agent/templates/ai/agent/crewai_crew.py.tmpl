"""
{{CREW_NAME}} - CrewAI Crew Setup

Purpose: {{CREW_PURPOSE}}
Author: {{AUTHOR}}
Date: {{DATE}}

Axiom Alignment:
- A2 (User Primacy): Crew ensures user goals are achieved
- A3 (Transparency): Agent roles and tasks are explicit
- A4 (Non-Harm): Crew validates actions before execution

This template provides a CrewAI 1.x crew implementation with:
- Multi-agent collaboration
- Task orchestration
- Memory integration
- Structured output
"""

from typing import List, Optional, Dict, Any
from crewai import Crew, Process
from crewai.agent import Agent
from crewai.task import Task
from crewai.tools import BaseTool
from pydantic import BaseModel, Field
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class {{CREW_CLASS_NAME}}Output(BaseModel):
    """
    Structured output from {{CREW_NAME}} crew execution.
    
    Provides complete execution trace for verifiability (A1).
    """
    result: str = Field(description="Final crew result")
    agent_results: Dict[str, str] = Field(
        default_factory=dict,
        description="Results from individual agents"
    )
    task_results: Dict[str, str] = Field(
        default_factory=dict,
        description="Results from individual tasks"
    )
    execution_time: float = Field(description="Execution time in seconds")
    tasks_completed: int = Field(description="Number of tasks completed")
    agents_involved: List[str] = Field(
        default_factory=list,
        description="List of agent roles involved"
    )


class {{CREW_CLASS_NAME}}:
    """
    {{CREW_NAME}} - CrewAI Crew Definition
    
    Defines a crew of agents working together to accomplish goals.
    Each agent has a specific role, goal, and backstory.
    
    Features:
    - Multi-agent collaboration
    - Sequential or hierarchical process execution
    - Task dependencies and orchestration
    - Memory support for context retention
    - Structured output with execution trace
    
    Example:
        >>> crew = {{CREW_CLASS_NAME}}(
        ...     verbose=True,
        ...     process=Process.sequential
        ... )
        >>> result = crew.kickoff(inputs={"topic": "AI research"})
        >>> print(result.result)
        >>> print(f"Completed {result.tasks_completed} tasks")
    """
    
    def __init__(
        self,
        verbose: bool = True,
        process: Process = Process.sequential,
        max_iter: int = {{MAX_ITERATIONS}},
        memory: bool = {{ENABLE_MEMORY}},
        model_name: Optional[str] = None,
        temperature: float = {{TEMPERATURE}}
    ):
        """
        Initialize {{CREW_NAME}} crew.
        
        Args:
            verbose: Enable verbose logging for transparency (A3)
            process: Process type (sequential, hierarchical, or consensual)
            max_iter: Maximum iterations per agent
            memory: Enable agent memory for context retention
            model_name: Optional custom LLM model name
            temperature: Sampling temperature for agents
        """
        self.verbose = verbose
        self.process = process
        self.max_iter = max_iter
        self.memory = memory
        self.model_name = model_name
        self.temperature = temperature
        
        # Create agents
        self.agents = self._create_agents()
        
        # Create tasks
        self.tasks = self._create_tasks()
        
        # Create crew
        self.crew = Crew(
            agents=self.agents,
            tasks=self.tasks,
            verbose=verbose,
            process=process,
            max_iter=max_iter,
            memory=memory
        )
        
        logger.info(
            f"Initialized {{CREW_NAME}} with {len(self.agents)} agents, "
            f"{len(self.tasks)} tasks, process={process}"
        )
    
    def _create_agents(self) -> List[Agent]:
        """
        Create agents for the crew.
        
        Override this method to customize agent configuration.
        
        Returns:
            List of Agent instances
        """
        agents = []
        
        # Agent 1: {{AGENT_1_ROLE}}
        agent_1 = Agent(
            role="{{AGENT_1_ROLE}}",
            goal="{{AGENT_1_GOAL}}",
            backstory="""{{AGENT_1_BACKSTORY}}
            
## Core Principles
- VERIFIABILITY (A1): Provide reasoning for decisions
- USER PRIMACY (A2): Prioritize user goals
- TRANSPARENCY (A3): Be explicit about actions
- NON-HARM (A4): Validate before executing consequential actions""",
            verbose=self.verbose,
            allow_delegation={{AGENT_1_ALLOW_DELEGATION}},
            max_iter=self.max_iter,
            memory=self.memory,
            tools=self._get_agent_1_tools()
        )
        agents.append(agent_1)
        
        # Agent 2: {{AGENT_2_ROLE}}
        agent_2 = Agent(
            role="{{AGENT_2_ROLE}}",
            goal="{{AGENT_2_GOAL}}",
            backstory="""{{AGENT_2_BACKSTORY}}
            
## Core Principles
- VERIFIABILITY (A1): Provide reasoning for decisions
- USER PRIMACY (A2): Prioritize user goals
- TRANSPARENCY (A3): Be explicit about actions
- NON-HARM (A4): Validate before executing consequential actions""",
            verbose=self.verbose,
            allow_delegation={{AGENT_2_ALLOW_DELEGATION}},
            max_iter=self.max_iter,
            memory=self.memory,
            tools=self._get_agent_2_tools()
        )
        agents.append(agent_2)
        
        # Add more agents as needed
        # Agent 3: {{AGENT_3_ROLE}}
        # agent_3 = Agent(...)
        # agents.append(agent_3)
        
        return agents
    
    def _create_tasks(self) -> List[Task]:
        """
        Create tasks for the crew.
        
        Override this method to customize task configuration.
        
        Returns:
            List of Task instances
        """
        tasks = []
        
        # Task 1: {{TASK_1_DESCRIPTION}}
        task_1 = Task(
            description="""{{TASK_1_DESCRIPTION}}
            
Expected Output: {{TASK_1_EXPECTED_OUTPUT}}""",
            agent=self.agents[0],  # Assign to first agent
            expected_output="{{TASK_1_EXPECTED_OUTPUT}}"
        )
        tasks.append(task_1)
        
        # Task 2: {{TASK_2_DESCRIPTION}}
        task_2 = Task(
            description="""{{TASK_2_DESCRIPTION}}
            
Expected Output: {{TASK_2_EXPECTED_OUTPUT}}""",
            agent=self.agents[1],  # Assign to second agent
            expected_output="{{TASK_2_EXPECTED_OUTPUT}}",
            context=[task_1]  # Task 2 depends on task 1
        )
        tasks.append(task_2)
        
        # Add more tasks as needed
        # Task 3: {{TASK_3_DESCRIPTION}}
        # task_3 = Task(...)
        # tasks.append(task_3)
        
        return tasks
    
    def _get_agent_1_tools(self) -> List[BaseTool]:
        """
        Get tools for agent 1.
        
        Override this method to provide custom tools.
        
        Returns:
            List of tools for agent 1
        """
        # Import your tools here
        # from your_tools import tool1, tool2
        # return [tool1, tool2]
        return []
    
    def _get_agent_2_tools(self) -> List[BaseTool]:
        """
        Get tools for agent 2.
        
        Override this method to provide custom tools.
        
        Returns:
            List of tools for agent 2
        """
        # Import your tools here
        # from your_tools import tool3, tool4
        # return [tool3, tool4]
        return []
    
    def kickoff(self, inputs: Dict[str, Any]) -> {{CREW_CLASS_NAME}}Output:
        """
        Kickoff crew execution.
        
        Args:
            inputs: Input dictionary for crew execution
                Example: {"topic": "AI research", "format": "report"}
        
        Returns:
            {{CREW_CLASS_NAME}}Output with results and execution trace
            
        Example:
            >>> result = crew.kickoff({
            ...     "topic": "Machine Learning",
            ...     "depth": "detailed"
            ... })
            >>> print(result.result)
            >>> print(f"Execution time: {result.execution_time:.2f}s")
        """
        import time
        
        logger.info(f"Kicking off {{CREW_NAME}} with inputs: {inputs}")
        start_time = time.time()
        
        try:
            # Execute crew
            crew_result = self.crew.kickoff(inputs=inputs)
            
            execution_time = time.time() - start_time
            
            # Extract agent results
            agent_results = {}
            task_results = {}
            agents_involved = []
            
            # Extract from crew result
            if hasattr(crew_result, 'tasks_output'):
                for task in self.tasks:
                    task_key = task.description[:50]  # Use description as key
                    task_output = getattr(crew_result, 'tasks_output', {})
                    task_results[task_key] = str(
                        task_output.get(task.description, "")
                    )
                    
                    # Track agent involvement
                    agent_role = task.agent.role
                    if agent_role not in agents_involved:
                        agents_involved.append(agent_role)
                    
                    # Aggregate agent results
                    if agent_role not in agent_results:
                        agent_results[agent_role] = []
                    agent_results[agent_role].append(
                        str(task_output.get(task.description, ""))
                    )
            
            # Convert agent results lists to strings
            agent_results_str = {
                role: "\n".join(results)
                for role, results in agent_results.items()
            }
            
            output = {{CREW_CLASS_NAME}}Output(
                result=str(crew_result),
                agent_results=agent_results_str,
                task_results=task_results,
                execution_time=execution_time,
                tasks_completed=len(self.tasks),
                agents_involved=agents_involved
            )
            
            logger.info(
                f"{{CREW_NAME}} execution completed in {execution_time:.2f}s. "
                f"Completed {len(self.tasks)} tasks with {len(agents_involved)} agents"
            )
            
            return output
            
        except Exception as e:
            logger.error(f"Error during {{CREW_NAME}} execution: {e}", exc_info=True)
            execution_time = time.time() - start_time
            return {{CREW_CLASS_NAME}}Output(
                result=f"Error: {str(e)}",
                agent_results={},
                task_results={},
                execution_time=execution_time,
                tasks_completed=0,
                agents_involved=[]
            )
    
    async def akickoff(self, inputs: Dict[str, Any]) -> {{CREW_CLASS_NAME}}Output:
        """
        Async version of kickoff.
        
        Args:
            inputs: Input dictionary for crew execution
        
        Returns:
            {{CREW_CLASS_NAME}}Output with results and execution trace
        """
        import time
        
        logger.info(f"Async kicking off {{CREW_NAME}}...")
        start_time = time.time()
        
        try:
            crew_result = await self.crew.akickoff(inputs=inputs)
            execution_time = time.time() - start_time
            
            agent_results = {}
            task_results = {}
            agents_involved = []
            
            if hasattr(crew_result, 'tasks_output'):
                for task in self.tasks:
                    task_key = task.description[:50]
                    task_output = getattr(crew_result, 'tasks_output', {})
                    task_results[task_key] = str(
                        task_output.get(task.description, "")
                    )
                    
                    agent_role = task.agent.role
                    if agent_role not in agents_involved:
                        agents_involved.append(agent_role)
                    
                    if agent_role not in agent_results:
                        agent_results[agent_role] = []
                    agent_results[agent_role].append(
                        str(task_output.get(task.description, ""))
                    )
            
            agent_results_str = {
                role: "\n".join(results)
                for role, results in agent_results.items()
            }
            
            return {{CREW_CLASS_NAME}}Output(
                result=str(crew_result),
                agent_results=agent_results_str,
                task_results=task_results,
                execution_time=execution_time,
                tasks_completed=len(self.tasks),
                agents_involved=agents_involved
            )
            
        except Exception as e:
            logger.error(f"Error during async {{CREW_NAME}} execution: {e}")
            execution_time = time.time() - start_time
            return {{CREW_CLASS_NAME}}Output(
                result=f"Error: {str(e)}",
                agent_results={},
                task_results={},
                execution_time=execution_time,
                tasks_completed=0,
                agents_involved=[]
            )


# Example usage
if __name__ == "__main__":
    # Create crew
    crew = {{CREW_CLASS_NAME}}(
        verbose=True,
        process=Process.sequential,
        memory=True
    )
    
    # Execute crew
    result = crew.kickoff({
        "{{INPUT_KEY_1}}": "{{EXAMPLE_INPUT_1}}",
        "{{INPUT_KEY_2}}": "{{EXAMPLE_INPUT_2}}"
    })
    
    print(f"Result: {result.result}")
    print(f"Execution Time: {result.execution_time:.2f}s")
    print(f"Tasks Completed: {result.tasks_completed}")
    print(f"Agents Involved: {result.agents_involved}")
    print(f"\nAgent Results:")
    for agent, output in result.agent_results.items():
        print(f"  {agent}: {output[:100]}...")