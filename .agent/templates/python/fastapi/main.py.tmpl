"""
{{ module_docstring(
    title='FastAPI Application Entry Point',
    description='Purpose: Initialize and configure FastAPI application\n' +
                'Axiom Alignment:\n' +
                '- A1 (Verifiability): Application configuration is explicit and documented\n' +
                '- A3 (Transparency): Clear startup and shutdown logging\n' +
                '- A4 (Non-Harm): Proper error handling and graceful shutdown',
    version='1.0.0',
    author='{{AUTHOR}}'
) }}
"""

{% from '_macros/python.tmpl' import import_block, function_def, async_function_def, decorator, module_docstring %}

{{ import_block([
    {'from': 'contextlib', 'names': ['asynccontextmanager']},
    {'from': 'fastapi', 'names': ['FastAPI', 'Request']},
    {'from': 'fastapi.middleware.cors', 'names': ['CORSMiddleware']},
    {'from': 'fastapi.middleware.trustedhost', 'names': ['TrustedHostMiddleware']},
    {'from': 'fastapi.responses', 'names': ['JSONResponse']},
    {'name': 'logging'},
    {'name': 'uvicorn'},
    {'from': '.config.settings', 'names': ['settings']},
    {'from': '.middleware.error_handler', 'names': ['global_exception_handler', '{{ERROR_HANDLER_CLASS_NAME}}']},
    {'from': '.domain.router', 'names': ['router'], 'alias': '{{MODULE_NAME}}_router'}
]) }}

# Configure logging
logging.basicConfig(
    level=getattr(logging, settings.log_level),
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


{{ decorator('asynccontextmanager') }}
{{ async_function_def(
    name='lifespan',
    description='Application lifespan context manager.\n\nHandles startup and shutdown logic for the FastAPI application.',
    params=[{'name': 'app', 'type': 'FastAPI'}],
    returns='None'
) }}
    # Startup
    logger.info(f"Starting {settings.app_name} v{settings.app_version}")
    logger.info(f"Environment: {settings.environment}")
    logger.info(f"Debug mode: {settings.debug}")

    # Initialize database connection pool, etc.
    # Example:
    # await init_database()
    # await init_redis()

    yield

    # Shutdown
    logger.info(f"Shutting down {settings.app_name}")
    # Cleanup resources
    # Example:
    # await close_database()
    # await close_redis()


{{ function_def(
    name='create_app',
    description='Create and configure FastAPI application.',
    returns='FastAPI'
) }}
    app = FastAPI(
        title=settings.api_title,
        version=settings.api_version,
        description="{{APP_DESCRIPTION}}",
        docs_url="/docs" if settings.debug else None,
        redoc_url="/redoc" if settings.debug else None,
        openapi_url="/openapi.json" if settings.debug else None,
        lifespan=lifespan
    )

    # Register exception handlers
    app.add_exception_handler(Exception, global_exception_handler)

    # Add middleware
    setup_middleware(app)

    # Register routers
    setup_routers(app)

    # Health check endpoint
    @app.get("/health", tags=["Health"])
    async def health_check():
        """
        Health check endpoint.

        Returns:
            Health status
        """
        return {
            "status": "healthy",
            "app": settings.app_name,
            "version": settings.app_version,
            "environment": settings.environment
        }

    return app


{{ function_def(
    name='setup_middleware',
    description='Configure application middleware.',
    params=[{'name': 'app', 'type': 'FastAPI'}],
    returns='None'
) }}
    # CORS middleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.cors_origins,
        allow_credentials=settings.cors_allow_credentials,
        allow_methods=settings.cors_allow_methods,
        allow_headers=settings.cors_allow_headers,
    )

    # Trusted host middleware (for production)
    if settings.is_production:
        app.add_middleware(
            TrustedHostMiddleware,
            allowed_hosts=["*"]  # Configure appropriately for your domain
        )

    logger.info("Middleware configured")


{{ function_def(
    name='setup_routers',
    description='Register application routers.',
    params=[{'name': 'app', 'type': 'FastAPI'}],
    returns='None'
) }}
    # Include domain routers
    app.include_router({{MODULE_NAME}}_router)

    # Add more routers as needed
    # app.include_router(another_router)

    logger.info("Routers registered")


# Create application instance
app = create_app()


{{ function_def(
    name='main',
    description='Main entry point for running the application.\n\nThis function starts the Uvicorn server with the configured settings.'
) }}
    uvicorn.run(
        "{{MODULE_NAME}}.main:app",
        host=settings.host,
        port=settings.port,
        reload=settings.debug,
        log_level=settings.log_level.lower()
    )


if __name__ == "__main__":
    main()
