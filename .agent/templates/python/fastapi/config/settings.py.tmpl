"""
{{ module_docstring(
    title='Application Settings - Configuration management using Pydantic BaseSettings',
    description='Purpose: Centralized configuration management with environment variable support\n' +
                'Axiom Alignment:\n' +
                '- A1 (Verifiability): All settings are typed and validated\n' +
                '- A3 (Transparency): Clear configuration structure and defaults\n' +
                '- A4 (Non-Harm): Sensitive values are properly handled',
    author='{{AUTHOR}}'
) }}
"""

{% from '_macros/python.tmpl' import import_block, function_def, pydantic_model, decorator %}

{{ import_block([
    {'from': 'typing', 'names': ['Optional', 'List']},
    {'from': 'pydantic', 'names': ['BaseSettings', 'Field', 'validator']},
    {'from': 'functools', 'names': ['lru_cache']},
    {'name': 'os'}
]) }}


{{ pydantic_model(
    name='Settings',
    description='Application settings with environment variable support.\n\nThis class uses Pydantic BaseSettings to automatically load\nconfiguration from environment variables. Settings can be\noverridden via .env file or environment variables.\n\nExample:\n    >>> settings = Settings()\n    >>> print(settings.database_url)',
    fields=[
        {'name': 'app_name', 'type': 'str', 'field': 'default="{{APP_NAME}}", description="Application name"'},
        {'name': 'app_version', 'type': 'str', 'field': 'default="1.0.0", description="Application version"'},
        {'name': 'debug', 'type': 'bool', 'field': 'default=False, description="Debug mode"'},
        {'name': 'environment', 'type': 'str', 'field': 'default="development", description="Environment (development, staging, production)"'},
        {'name': 'api_prefix', 'type': 'str', 'field': 'default="/api/v1", description="API URL prefix"'},
        {'name': 'api_title', 'type': 'str', 'field': 'default="{{APP_NAME}} API", description="API documentation title"'},
        {'name': 'api_version', 'type': 'str', 'field': 'default="1.0.0", description="API version"'},
        {'name': 'host', 'type': 'str', 'field': 'default="0.0.0.0", description="Server host"'},
        {'name': 'port', 'type': 'int', 'field': 'default=8000, ge=1, le=65535, description="Server port"'},
        {'name': 'database_url', 'type': 'str', 'field': '..., description="Database connection URL"'},
        {'name': 'database_pool_size', 'type': 'int', 'field': 'default=10, ge=1, description="Database connection pool size"'},
        {'name': 'database_max_overflow', 'type': 'int', 'field': 'default=20, ge=0, description="Database connection pool max overflow"'},
        {'name': 'database_echo', 'type': 'bool', 'field': 'default=False, description="Echo SQL queries (for debugging)"'},
        {'name': 'secret_key', 'type': 'str', 'field': '..., min_length=32, description="Secret key for encryption"'},
        {'name': 'algorithm', 'type': 'str', 'field': 'default="HS256", description="JWT algorithm"'},
        {'name': 'access_token_expire_minutes', 'type': 'int', 'field': 'default=30, ge=1, description="Access token expiration time in minutes"'},
        {'name': 'cors_origins', 'type': 'List[str]', 'field': 'default=["http://localhost:3000", "http://localhost:8000"], description="Allowed CORS origins"'},
        {'name': 'cors_allow_credentials', 'type': 'bool', 'field': 'default=True, description="Allow CORS credentials"'},
        {'name': 'cors_allow_methods', 'type': 'List[str]', 'field': 'default=["*"], description="Allowed CORS methods"'},
        {'name': 'cors_allow_headers', 'type': 'List[str]', 'field': 'default=["*"], description="Allowed CORS headers"'},
        {'name': 'log_level', 'type': 'str', 'field': 'default="INFO", description="Logging level"'},
        {'name': 'log_format', 'type': 'str', 'field': 'default="json", description="Log format (json, text)"'}
    ]
) }}

    # External Services (add as needed)
    # redis_url: Optional[str] = Field(None, description="Redis connection URL")
    # redis_ttl: int = Field(default=3600, description="Redis TTL in seconds")

    class Config:
        """Pydantic configuration."""
        env_file = ".env"
        env_file_encoding = "utf-8"
        case_sensitive = False

        # Allow nested settings
        env_nested_delimiter = "__"

    @validator("environment")
    def validate_environment(cls, v):
        """
        Validate environment value.

        Args:
            v: Environment value

        Returns:
            Validated environment

        Raises:
            ValueError: If environment is invalid
        """
        allowed = ["development", "staging", "production"]
        if v not in allowed:
            raise ValueError(f"Environment must be one of {allowed}")
        return v

    @validator("log_level")
    def validate_log_level(cls, v):
        """
        Validate log level value.

        Args:
            v: Log level value

        Returns:
            Validated log level

        Raises:
            ValueError: If log level is invalid
        """
        allowed = ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        if v.upper() not in allowed:
            raise ValueError(f"Log level must be one of {allowed}")
        return v.upper()

    @property
    def database_url_sync(self) -> str:
        """
        Get synchronous database URL (for Alembic migrations).

        Returns:
            Synchronous database URL
        """
        # Convert async URL to sync if needed
        # Example: postgresql+asyncpg:// -> postgresql://
        return self.database_url.replace("+asyncpg", "").replace("+aiomysql", "")

    @property
    def is_production(self) -> bool:
        """
        Check if running in production environment.

        Returns:
            True if production, False otherwise
        """
        return self.environment == "production"

    @property
    def is_development(self) -> bool:
        """
        Check if running in development environment.

        Returns:
            True if development, False otherwise
        """
        return self.environment == "development"


{{ decorator('lru_cache') }}
{{ function_def(
    name='get_settings',
    description='Get cached settings instance.\n\nThis function uses LRU cache to ensure settings are loaded\nonly once and reused across the application.',
    returns='Settings'
) }}
    return Settings()


# Export settings instance
settings = get_settings()
